!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.jso=t():e.jso=t()}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=9)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var o=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),console.log("Initializing a loader with url "+t),this.url=t}return r(e,[{key:"execute",value:function(){}}]),e}();t.default=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={epoch:function(){return Math.round((new Date).getTime()/1e3)},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},parseQueryString:function(e){for(var t,n=/\+/g,r=/([^&;=]+)=?([^&;]*)/g,o=function(e){return decodeURIComponent(e.replace(n," "))},i=e,a={};t=r.exec(i);)a[o(t[1])]=o(t[2]);return a},scopeList:function(e){return r.uniqueList(e).join(" ")},uniqueList:function(e){for(var t={},n=[],r=0;r<e.length;r++)t[e[r]]=1;for(var o in t)t.hasOwnProperty(o)&&n.push(o);return n}};r.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},r.log=function(e){var t;console&&(console.log&&(arguments.length>1?(t=console).log.apply(t,["[JSO]"].concat(Array.prototype.slice.call(arguments))):console.log("[JSO]",e)))},r.encodeURL=function(e,t){var n,r=e,o=0,i=-1===e.indexOf("?")?"?":"&";for(n in t)r+=(0==o++?i:"&")+encodeURIComponent(n)+"="+encodeURIComponent(t[n]);return r},r.epoch=function(){return Math.round((new Date).getTime()/1e3)},t.default=r},function(e){e.exports={name:"jso",version:"4.0.0-rc.3",description:"OAuth 2.0 implementation in Javascript",main:"dist/jso.js",module:"src/JSO.js",scripts:{test:"true",preversion:"npm test",version:"npm run build && git add -A dist",postversion:"git push && git push --tags && npm publish",build:"webpack --mode production"},repository:{type:"git",url:"https://github.com/andreassolberg/jso.git"},keywords:["oauth","authentication","authorization","rest","api","ajax","jquery"],files:["src"],eslintConfig:{env:{es6:!0,browser:!0,node:!1}},devDependencies:{"babel-core":"^6.26.0","babel-preset-env":"^1.6.1","babel-loader":"^7.1.4","babel-preset-react":"^6.24.1",qunit:"^2.5.1",webpack:"^4.1.1"},author:"Andreas Ã…kre Solberg",license:"LGPL-2.1",bugs:{url:"https://github.com/andreassolberg/jso/issues"},homepage:"https://github.com/andreassolberg/jso",dependencies:{"webpack-cli":"^2.0.12"}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return r(e,[{key:"on",value:function(e,t){this._callbacks||(this._callbacks={}),this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(t)}},{key:"emit",value:function(e){this._callbacks||(this._callbacks={}),this._callbacks[e]||(this._callbacks[e]=[]);for(var t=Array.prototype.slice.call(arguments,1),n=0;n<this._callbacks[e].length;n++)this._callbacks[e][n].apply(this,t)}}]),e}();t.default=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.config={};for(var t=0;t<arguments.length;t++)Object.assign(this.config,arguments[t])}return r(e,[{key:"has",value:function(e){var t=this.config,n=e.split("."),r=0;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;t=t[n[r]]}return!0}},{key:"getValue",value:function(e,t,n){n=n||!1;var r=this.config,o=e.split("."),i=0;for(i=0;i<o.length;i++){if(!r.hasOwnProperty(o[i])){r=void 0;break}r=r[o[i]]}if(void 0===r){if(n)throw new Error("Configuration option ["+o[i]+"] required but not provided.");return t}return r}}]),e}();t.default=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(0),a=(r=i)&&r.__esModule?r:{default:r};var u=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),o(t,[{key:"execute",value:function(){var e=this;return console.error("Popup loaded..."),new Promise(function(t,n){window.addEventListener("message",function(e){console.log("Sent a message to event.origin "+e.origin+" and got the following in response:"),console.log("<em>"+e.data+"</em>");var n=r.location.href;console.error("Popup location is ",n,r.location),t(n)}),window.popupCompleted=function(){var e=r.location.href;console.error("Popup location is ",e,r.location),t(e)};var r=window.open(e.url,"uwap-auth","height=600,width=800");if(console.log("Newwindow is ",r),null===r)throw new Error("Error loading popup window");window.focus&&r.focus()})}}]),t}();t.default=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(0),a=(r=i)&&r.__esModule?r:{default:r};var u=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));console.error("Constructor IFrame...");var r=n;return n.timeout=5e3,n.callback=null,n.isCompleted=!1,n.iframe=$('<iframe class="jso_messenger_iframe" style="display: none;" src="'+e+'"></iframe>').on("load",function(){try{var e=this.contentWindow.window.location.href;r._completed(e)}catch(e){console.error("Security exception with iframe loading.",e)}}),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),o(t,[{key:"execute",value:function(){var e=this;return console.error("Execute IFrame..."),new Promise(function(t,n){e.callback=t,$("body").prepend(e.iframe),setTimeout(function(){e.isCompleted||(e.isCompleted=!0,e._cleanup(),n(new Error("Loading iframe timed out")))},e.timeout)})}},{key:"_cleanup",value:function(){this.iframe.remove()}},{key:"_completed",value:function(e){this.isCompleted||(this.callback&&"function"==typeof this.callback&&this.callback(e),this.isCompleted=!0,this._cleanup())}}]),t}();t.default=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(0),a=(r=i)&&r.__esModule?r:{default:r};var u=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),o(t,[{key:"execute",value:function(){var e=this;return new Promise(function(t,n){window.location=e.url,t()})}}]),t}();t.default=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(1),a=(r=i)&&r.__esModule?r:{default:r};var u=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return o(e,[{key:"saveState",value:function(e,t){localStorage.setItem("state-"+e,JSON.stringify(t))}},{key:"getState",value:function(e){var t=JSON.parse(localStorage.getItem("state-"+e));return localStorage.removeItem("state-"+e),t}},{key:"hasScope",value:function(e,t){var n;if(!e.scopes)return!1;for(n=0;n<e.scopes.length;n++)if(e.scopes[n]===t)return!0;return!1}},{key:"filterTokens",value:function(e,t){var n,r,o,i=[],u=a.default.epoch();for(t||(t=[]),n=0;n<e.length;n++){for(o=!0,e[n].expires&&e[n].expires<u+1&&(o=!1),r=0;r<t.length;r++)store.hasScope(e[n],t[r])||(o=!1);o&&i.push(e[n])}return i}},{key:"saveTokens",value:function(e,t){localStorage.setItem("tokens-"+e,JSON.stringify(t))}},{key:"getTokens",value:function(e){var t=JSON.parse(localStorage.getItem("tokens-"+e));return t||(t=[]),a.default.log("Token received",t),t}},{key:"wipeTokens",value:function(e){localStorage.removeItem("tokens-"+e)}},{key:"saveToken",value:function(e,t){var n=this.getTokens(e);(n=this.filterTokens(n)).push(t),this.saveTokens(e,n)}},{key:"getToken",value:function(e,t){var n=this.getTokens(e);return(n=this.filterTokens(n,t)).length<1?null:n[0]}}]),e}());t.default=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Popup=t.HTTPRedirect=t.BasicLoader=t.JSO=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=f(n(8)),i=f(n(1)),a=f(n(0)),u=f(n(7)),s=(f(n(6)),f(n(5))),l=f(n(4)),c=f(n(3));function f(e){return e&&e.__esModule?e:{default:e}}function p(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var d=n(2),h={lifetime:3600,debug:!0},g=function(){function e(t){p(this,e),this.configure(t),this.providerID=this.getProviderID(),this.Loader=u.default,this.callbacks={}}return r(e,[{key:"configure",value:function(e){this.config=new l.default(h,e)}},{key:"setLoader",value:function(e){if("function"!=typeof e)throw new Error("loader MUST be an instance of the JSO BasicLoader");this.Loader=e}},{key:"on",value:function(e,t){if("string"!=typeof e)throw new Error("Registering triggers on JSO must be identified with an event id");if("function"!=typeof t)throw new Error("Registering a callback on JSO must be a function.");this.callbacks[e]=t}},{key:"getProviderID",value:function(){var e=this.config.getValue("providerID",null);if(null!==e)return e;var t=this.config.getValue("client_id",null,!0);return this.config.getValue("authorization",null,!0)+"|"+t}},{key:"processTokenResponse",value:function(e){var t=this;return new Promise(function(n,r){var a,u=i.default.epoch();if(!e.state)throw new Error("Could not get state from storage.");if(!(a=o.default.getState(e.state)))throw new Error("Could not retrieve state");if(!a.providerID)throw new Error("Could not get providerid from state");i.default.log("Checking atoken ",e,""),e.expires_in?e.expires=u+parseInt(e.expires_in,10):!1===t.config.getValue("default_lifetime",null)?e.expires=null:t.config.has("permanent_scope")?o.default.hasScope(e,t.config.getValue("permanent_scope"))||(e.expires=null):t.config.has("default_lifetime")?e.expires=u+t.config.getValue("default_lifetime"):e.expires=u+3600,e.scope?e.scopes=e.scope.split(" "):a.scopes?e.scopes=a.scopes:e.scopes=[],o.default.saveToken(a.providerID,e),a.restoreHash?window.location.hash=a.restoreHash:window.location.hash="",n(e)})}},{key:"processErrorResponse",value:function(t){return new Promise(function(n,r){var i;if(!t.state)throw new Error("Could not get [state] and no default providerid is provided.");if(!(i=o.default.getState(t.state)))throw new Error("Could not retrieve state");if(!i.providerID)throw new Error("Could not get providerid from state");i.restoreHash?window.location.hash=i.restoreHash:window.location.hash="",r(new e.OAuthResponseError(t))})}},{key:"callback",value:function(e){var t=this;return Promise.resolve().then(function(){var n,r=window.location.hash;if(i.default.log("JSO.prototype.callback() "+e),e){if(-1===e.indexOf("#"))return;r=e.substring(e.indexOf("#"))}if(!(r.length<2))return r=r.substring(1),(n=i.default.parseQueryString(r)).hasOwnProperty("access_token")?t.processTokenResponse(n):n.hasOwnProperty("error")?t.processErrorResponse(n):void 0})}},{key:"dump",value:function(){var e=o.default.getTokens(this.providerID);return{providerID:this.providerID,tokens:e,config:this.config}}},{key:"_getRequestScopes",value:function(e){var t,n=[];if(this.config.has("scopes.request")){var r=this.config.getValue("scopes.request");for(t=0;t<r.length;t++)n.push(r[t])}if(e&&e.scopes&&e.scopes.request)for(t=0;t<e.scopes.request.length;t++)n.push(e.scopes.request[t]);return i.default.uniqueList(n)}},{key:"_getRequiredScopes",value:function(e){var t,n=[];if(this.config.has("scopes.require")){var r=this.config.getValue("scopes.require");for(t=0;t<r.length;t++)n.push(r[t])}if(e&&e.scopes&&e.scopes.require)for(t=0;t<e.scopes.require.length;t++)n.push(e.scopes.require[t]);return i.default.uniqueList(n)}},{key:"getToken",value:function(e){var t=this;return Promise.resolve().then(function(){var n=t._getRequiredScopes(e),r=o.default.getToken(t.providerID,n);return Promise.resolve().then(function(){if(r)return r;if(e.hasOwnProperty("allowredir")&&!e.allowredir)throw new Error("Cannot obtain a token, when not allowed to redirect...");return t._authorize(e)})})}},{key:"checkToken",value:function(e){var t=this._getRequiredScopes(e);return o.default.getToken(this.providerID,t)}},{key:"_authorize",value:function(e){var t,n,r,a=this;return Promise.resolve().then(function(){var u=a.config.getValue("authorization",null,!0),s=a.config.getValue("client_id",null,!0);i.default.log("About to send an authorization request to this entry:",u),i.default.log("Options",e),t={response_type:a.config.getValue("response_type","token"),state:i.default.uuid()},e.hasOwnProperty("allowia")&&!e.allowia&&(t.prompt="none"),a.config.has("redirect_uri")&&(t.redirect_uri=a.config.getValue("redirect_uri","")),e.redirect_uri&&(t.redirect_uri=e.redirect_uri),t.client_id=s,(r=a._getRequestScopes(e)).length>0&&(t.scope=i.default.scopeList(r)),i.default.log("DEBUG REQUEST"),i.default.log(t),n=i.default.encodeURL(u,t),window.location.hash&&(t.restoreHash=window.location.hash),t.providerID=a.providerID,r&&(t.scopes=r),i.default.log("Saving state ["+t.state+"]"),i.default.log(JSON.parse(JSON.stringify(t)));var l=a.Loader;return e.hasOwnProperty("loader")&&(l=e.loader),i.default.log("Looking for loader",e,l),o.default.saveState(t.state,t),a.gotoAuthorizeURL(n,l).then(function(e){return a.callback(e)})})}},{key:"gotoAuthorizeURL",value:function(e,t){return new Promise(function(n,r){if(null!==t&&"function"==typeof t){var o=new t(e);if(!(o instanceof a.default))throw new Error("JSO selected Loader is not an instance of BasicLoader.");n(o.execute().then(function(e){return e}))}else r(new Error("Cannot redirect to authorization endpoint because of missing redirect handler"))})}},{key:"wipeTokens",value:function(){o.default.wipeTokens(this.providerID)}},{key:"request",value:function(t){var n=$.extend(!0,{},{dataType:"json"},t);return this.ajax(n).catch(function(n){if(n instanceof e.HTTPError){var r="HTTP status ("+n.jqXHR.status+"), JSO error on ["+t.url+"] "+n.jqXHR.textStatus;if(n.message=r,n.httpError=r,n.jqXHR.hasOwnProperty("responseText")&&"string"==typeof n.jqXHR.responseText)try{var o=JSON.parse(n.jqXHR.responseText);o.hasOwnProperty("message")&&(n.message=o.message),n.data=o}catch(e){e.message=e.message+". Unable to parse JSON response of this HTTP error."}}throw n})}},{key:"ajax",value:function(t){var n=this,r=t.oauth||{};return this.getToken(r).then(function(o){if(o){if(null===o)throw new Error("Cannot perform AJAX call without a token.");return i.default.log("Ready. Got an token, and ready to perform an AJAX call",o),new Promise(function(a,u){r.allowia;t.error=function(t,r,o){i.default.log("error(jqXHR, textStatus, errorThrown)"),i.default.log(t),i.default.log(r),i.default.log(o),401===t.status&&(i.default.log("Token expired. About to delete this token"),n.wipeTokens(),u(new e.ExpiredTokenError({}).set("message","Token was expired and is now deleted. Try again.")));var a=new e.HTTPError({}).set("jqXHR",t).set("textStatus",r).set("errorThrown",o);u(a)},t.success=function(e){a(e)},"qs"===n.config.getValue("presenttoken",null)?(t.data||(t.data={}),t.data.access_token=o.access_token):(t.headers||(t.headers={}),t.headers.Authorization="Bearer "+o.access_token),i.default.log("$.ajax settings",t),e.$.ajax(t)})}i.default.log("No token no fun")})}},{key:"inappbrowser",value:function(e){var t=this;return e=e||{},function(n,r){var o="_blank";e.hasOwnProperty("target")&&(o=e.target);i.default.log("About to open url "+n);var a=window.open(n,o,{});i.default.log("URL Loaded... "),a.addEventListener("loadstart",function(e){return function(n){var o=n.url;i.default.log("loadstop event triggered, and the url is now "+o),t.URLcontainsToken(o)&&(setTimeout(function(){e.close()},500),t.callback(o,function(){i.default.log("Closing window ",e),"function"==typeof r&&r()}))}}(a)),i.default.log("Event listeren ardded... ",a)}}},{key:"URLcontainsToken",value:function(e){var t;if(e){if(-1===e.indexOf("#"))return!1;t=e.substring(e.indexOf("#"))}return!(t.length<2)&&-1!==t.indexOf("access_token")}}],[{key:"info",value:function(){var e={};return e.version=d.version,e}}]),e}();g.OAuthResponseError=function(){return function e(t){for(var n in p(this,e),t)this[n]=t[n]}}(),g.ExpiredTokenError=function(){return function e(t){for(var n in p(this,e),t)this[n]=t[n]}}(),g.HTTPError=function(){return function e(t){for(var n in p(this,e),t)this[n]=t[n]}}(),Object.assign(g.prototype,new c.default({})),t.JSO=g,t.BasicLoader=a.default,t.HTTPRedirect=u.default,t.Popup=s.default}])});